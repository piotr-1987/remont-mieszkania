<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ZarzƒÖdzanie Wydatkami Mieszkanie 56</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 20px auto; }
    img#logo { max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; }
    form > div { margin-bottom: 10px; }
    label { display: inline-block; width: 130px; font-weight: bold; vertical-align: top; }
    input, select { width: 220px; padding: 5px; }
    input[type="number"] { width: 100px; }
    button { margin-right: 8px; padding: 6px 12px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f7f7f7; }
    .action-btn { margin-right: 5px; }
    .error { color: red; margin-top: 5px; }
    .filter-section { margin-bottom: 20px; }
    #chartContainer { width: 100%; max-width: 700px; margin-top: 30px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body>

  <!-- Logo -->
  <img id="logo" src="https://jakon-inwest.pl/upload/pictures/budynekb.jpg" alt="Wizualizacja Sielskie Podolany" />

  <h1>ZarzƒÖdzanie Wydatkami Mieszkanie 56</h1>

<!-- Filtry -->
  <div class="filter-section">
    <label for="filterDodajacy">DodajƒÖcy:</label>
    <input type="text" id="filterDodajacy" placeholder="Wpisz nazwƒô..." />
    <label for="filterKtoPlaci" style="margin-left: 20px;">Kto p≈Çaci:</label>
    <input type="text" id="filterKtoPlaci" placeholder="Wpisz nazwƒô..." />
  </div>
  <div class="filter-section">
    <label for="filterPomieszczenie">Pomieszczenie:</label>
    <input type="text" id="filterPomieszczenie" placeholder="Wpisz pomieszczenie..." />
    <label for="filterKategoria" style="margin-left: 20px;">Kategoria:</label>
    <input type="text" id="filterKategoria" placeholder="Wpisz kategoriƒô..." />
  </div>
  <div class="filter-section">
    <label for="filterNazwa">Nazwa:</label>
    <input type="text" id="filterNazwa" placeholder="Wpisz nazwƒô..." />
    <label for="filterModel" style="margin-left: 20px;">Model:</label>
    <input type="text" id="filterModel" placeholder="Wpisz model..." />
  </div>
  <button id="clearFilters">Wyczy≈õƒá filtry</button>

  <!-- Tabela danych -->
  <table id="expensesTable">
    <thead>
      <tr>
        <th>Data</th>
        <th>Typ</th>
        <th>Nazwa</th>
        <th>Model</th>
        <th>Pomieszczenie</th>
        <th>Kategoria</th>
        <th>Kwota (z≈Ç)</th>
        <th>Dokument</th>
        <th>DodajƒÖcy</th>
        <th>Kto p≈Çaci</th>
        <th>Akcje</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="summary">Do tej pory wydano: 0.00 z≈Ç</div>

  <!-- Formularz dodawania/edycji -->
  <h2 id="formTitle">Dodaj nowy wydatek</h2>
  <form id="expenseForm" novalidate>
    <input type="hidden" id="editRow" value="" />
    <div>
      <label for="data">Data*:</label>
      <input type="date" id="data" name="data" required />
      <span class="error" id="errorData"></span>
    </div>
    <div>
      <label for="typ">Typ*:</label>
      <input type="text" id="typ" name="typ" required />
      <span class="error" id="errorTyp"></span>
    </div>
    <div>
      <label for="nazwa">Nazwa:</label>
      <input type="text" id="nazwa" name="nazwa" />
    </div>
    <div>
      <label for="model">Model:</label>
      <input type="text" id="model" name="model" />
    </div>
    <div>
      <label for="pomieszczenie">Pomieszczenie:</label>
      <input type="text" id="pomieszczenie" name="pomieszczenie" />
    </div>
    <div>
      <label for="kategoria">Kategoria:</label>
      <input type="text" id="kategoria" name="kategoria" />
    </div>
    <div>
      <label for="kwota">Kwota*:</label>
      <input type="number" id="kwota" name="kwota" step="0.01" required />
      <span class="error" id="errorKwota"></span>
    </div>
    <div>
      <label for="dokument">Dokument:</label>
      <input type="text" id="dokument" name="dokument" />
    </div>
    <div>
      <label for="dodajacy">DodajƒÖcy:</label>
      <input type="text" id="dodajacy" name="dodajacy" />
    </div>
    <div>
      <label for="kto_placi">Kto p≈Çaci:</label>
      <input type="text" id="kto_placi" name="kto_placi" />
    </div>
    <button type="submit">Zapisz</button>
    <button type="button" id="cancelEdit" style="display:none;">Anuluj</button>
  </form>

  <!-- Kontener wykresu -->
  <div id="chartContainer">
    <canvas id="expensesChart" width="900" height="350"></canvas>
    <div id="chartLegend"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Podmie≈Ñ na sw√≥j URL Google Apps Script WebApp
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzjP7UdZdqoIEGK98tGH6RAK9U39cVmMMBlZe2h7DcAPLG9VyNq_30qCJvwz-IrXfn-EA/exec";

    let expensesData = [];

    // Pobierz dane z serwera (GET)
    async function fetchData() {
      try {
        const url = new URL(SCRIPT_URL);
        url.searchParams.append("action", "getData");

        const response = await fetch(url.toString());
        if (!response.ok) throw new Error("B≈ÇƒÖd pobierania danych z serwera");

        expensesData = await response.json();
        applyFiltersAndRender();
      } catch (error) {
        alert("B≈ÇƒÖd podczas pobierania danych: " + error.message);
      }
    }

    // Filtruj i renderuj tabelƒô + wykres + podsumowania
    function applyFiltersAndRender() {
      const filterDodajacy = document.getElementById("filterDodajacy").value.trim().toLowerCase();
      const filterKtoPlaci = document.getElementById("filterKtoPlaci").value.trim().toLowerCase();
      const filterPomieszczenie = document.getElementById("filterPomieszczenie").value.trim().toLowerCase();
      const filterKategoria = document.getElementById("filterKategoria").value.trim().toLowerCase();
      const filterNazwa = document.getElementById("filterNazwa").value.trim().toLowerCase();
      const filterModel = document.getElementById("filterModel").value.trim().toLowerCase();

      let filtered = expensesData;

      if (filterDodajacy !== "") {
        filtered = filtered.filter(e => (e.dodajacy || "").toLowerCase().includes(filterDodajacy));
      }
      if (filterKtoPlaci !== "") {
        filtered = filtered.filter(e => (e.kto_placi || "").toLowerCase().includes(filterKtoPlaci));
      }
      if (filterPomieszczenie !== "") {
        filtered = filtered.filter(e => (e.pomieszczenie || "").toLowerCase().includes(filterPomieszczenie));
      }
      if (filterKategoria !== "") {
        filtered = filtered.filter(e => (e.kategoria || "").toLowerCase().includes(filterKategoria));
      }
      if (filterNazwa !== "") {
        filtered = filtered.filter(e => (e.nazwa || "").toLowerCase().includes(filterNazwa));
      }
      if (filterModel !== "") {
        filtered = filtered.filter(e => (e.model || "").toLowerCase().includes(filterModel));
      }

      renderTable(filtered);
      renderSummary(filtered);
      renderChart(filtered);
    }

    // Renderowanie tabeli
    function renderTable(data) {
      const tbody = document.querySelector("#expensesTable tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='11' style='text-align:center;'>Brak danych do wy≈õwietlenia</td></tr>";
        return;
      }

      data.forEach((row, i) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${row.data || ""}</td>
          <td>${row.typ || ""}</td>
          <td>${row.nazwa || ""}</td>
          <td>${row.model || ""}</td>
          <td>${row.pomieszczenie || ""}</td>
          <td>${row.kategoria || ""}</td>
          <td style="text-align:right;">${Number(row.kwota).toFixed(2)}</td>
          <td>${row.dokument || ""}</td>
          <td>${row.dodajacy || ""}</td>
          <td>${row.kto_placi || ""}</td>
          <td>
            <button class="action-btn" onclick="editExpense(${i})">‚úèÔ∏è</button>
            <button class="action-btn" onclick="deleteExpense(${i})" style="color:#a00;">üóëÔ∏è</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Renderowanie podsumowania sumy wydatk√≥w i kto ile wyda≈Ç
    function renderSummary(data) {
      const total = data.reduce((acc, e) => acc + parseFloat(e.kwota || 0), 0);
      const summaryDiv = document.getElementById("summary");
      summaryDiv.textContent = `Do tej pory wydano: ${total.toFixed(2)} z≈Ç`;

      // Dodatkowo, kto ile wyda≈Ç:
      // Mo≈ºemy pokazaƒá w konsoli lub rozbudowaƒá UI, tutaj przyk≈Çad w konsoli:
      const ktoPlaciSums = {};
      data.forEach(e => {
        const key = e.kto_placi || "Nieznany";
        ktoPlaciSums[key] = (ktoPlaciSums[key] || 0) + parseFloat(e.kwota || 0);
      });
      console.log("Podsumowanie wydatk√≥w wg 'Kto p≈Çaci':", ktoPlaciSums);
    }

    // Renderowanie wykresu miesiƒôcznego wydatk√≥w
    let chartInstance = null;
    function renderChart(data) {
      // Agreguj sumy miesiƒôczne (YYYY-MM)
      const monthlySums = {};

      data.forEach(e => {
        if (!e.data) return;
        const ym = e.data.slice(0,7); // "YYYY-MM"
        monthlySums[ym] = (monthlySums[ym] || 0) + parseFloat(e.kwota || 0);
      });

      // Sortowanie miesiƒôcy rosnƒÖco
      const labels = Object.keys(monthlySums).sort();
      const values = labels.map(l => monthlySums[l]);

      const ctx = document.getElementById("expensesChart").getContext("2d");

      if(chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Wydatki miesiƒôczne (z≈Ç)',
            data: values,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1,
            borderRadius: 4,
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => val.toFixed(2)
              }
            }
          },
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: ctx => ctx.parsed.y.toFixed(2) + " z≈Ç"
              }
            }
          },
          responsive: true,
          maintainAspectRatio: false
        }
      });
    }

    // Obs≈Çuga formularza dodawania i edycji
    document.getElementById("expenseForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      clearErrors();

      // Walidacja
      const dataVal = this.data.value.trim();
      const typVal = this.typ.value.trim();
      const kwotaVal = this.kwota.value.trim();

      let valid = true;
      if (!dataVal) {
        showError("errorData", "Pole data jest wymagane");
        valid = false;
      }
      if (!typVal) {
        showError("errorTyp", "Pole typ jest wymagane");
        valid = false;
      }
      if (!kwotaVal || isNaN(kwotaVal) || parseFloat(kwotaVal) <= 0) {
        showError("errorKwota", "Podaj prawid≈ÇowƒÖ kwotƒô wiƒôkszƒÖ od 0");
        valid = false;
      }

      if (!valid) return;

      const editIndex = document.getElementById("editRow").value;

      // Pobieramy dane z formularza
      const newExpense = {
        data: dataVal,
        typ: typVal,
        nazwa: this.nazwa.value.trim(),
        model: this.model.value.trim(),
        pomieszczenie: this.pomieszczenie.value.trim(),
        kategoria: this.kategoria.value.trim(),
        kwota: parseFloat(kwotaVal).toFixed(2),
        dokument: this.dokument.value.trim(),
        dodajacy: this.dodajacy.value.trim(),
        kto_placi: this.kto_placi.value.trim(),
      };

      if (editIndex === "") {
        // Dodawanie nowego
        await addExpense(newExpense);
      } else {
        // Edycja istniejƒÖcego
        await updateExpense(parseInt(editIndex), newExpense);
      }

      resetForm();
      await fetchData();
    });

    function showError(id, message) {
      const el = document.getElementById(id);
      if(el) el.textContent = message;
    }
    function clearErrors() {
      ["errorData", "errorTyp", "errorKwota"].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.textContent = "";
      });
    }

    // Resetowanie formularza po zapisie lub anulowaniu
    function resetForm() {
      const form = document.getElementById("expenseForm");
      form.reset();
      document.getElementById("editRow").value = "";
      document.getElementById("formTitle").textContent = "Dodaj nowy wydatek";
      document.getElementById("cancelEdit").style.display = "none";
    }
    document.getElementById("cancelEdit").addEventListener("click", resetForm);

    // Edycja pozycji w tabeli
    function editExpense(index) {
      const expense = expensesData[index];
      if (!expense) return;

      document.getElementById("data").value = expense.data || "";
      document.getElementById("typ").value = expense.typ || "";
      document.getElementById("nazwa").value = expense.nazwa || "";
      document.getElementById("model").value = expense.model || "";
      document.getElementById("pomieszczenie").value = expense.pomieszczenie || "";
      document.getElementById("kategoria").value = expense.kategoria || "";
      document.getElementById("kwota").value = expense.kwota || "";
      document.getElementById("dokument").value = expense.dokument || "";
      document.getElementById("dodajacy").value = expense.dodajacy || "";
      document.getElementById("kto_placi").value = expense.kto_placi || "";
      document.getElementById("editRow").value = index;

      document.getElementById("formTitle").textContent = "Edytuj wydatek";
      document.getElementById("cancelEdit").style.display = "inline-block";
      window.scrollTo({top:0, behavior: 'smooth'});
    }

    // Usuwanie pozycji
    async function deleteExpense(index) {
      if(!confirm("Czy na pewno chcesz usunƒÖƒá ten wydatek?")) return;

      const expense = expensesData[index];
      if(!expense) return;

      try {
        const url = new URL(SCRIPT_URL);
        url.searchParams.append("action", "deleteData");
        url.searchParams.append("data", JSON.stringify(expense));

        const response = await fetch(url.toString(), { method: "POST" });
        if(!response.ok) throw new Error("B≈ÇƒÖd podczas usuwania danych");

        await fetchData();
      } catch (error) {
        alert("B≈ÇƒÖd podczas usuwania: " + error.message);
      }
    }

    // Dodawanie nowego wydatku (wysy≈Çka do Google Apps Script)
    async function addExpense(expense) {
      try {
        const url = new URL(SCRIPT_URL);
        url.searchParams.append("action", "addData");
        url.searchParams.append("data", JSON.stringify(expense));

        const response = await fetch(url.toString(), { method: "POST" });
        if (!response.ok) throw new Error("B≈ÇƒÖd podczas zapisu danych");

      } catch (error) {
        alert("B≈ÇƒÖd podczas dodawania wydatku: " + error.message);
      }
    }

    // Aktualizacja wydatku (usu≈Ñ i dodaj ponownie lub je≈õli masz dedykowanƒÖ metodƒô update - u≈ºyj jej)
    async function updateExpense(index, expense) {
      // Mo≈ºemy zaimplementowaƒá delete + add albo update je≈õli wspierane
      // Tu uproszczenie: usuniƒôcie orygina≈Çu + dodanie nowego (w praktyce lepiej update)

      // Najpierw usu≈Ñ orygina≈Ç
      const original = expensesData[index];
      if (!original) return;

      try {
        const urlDelete = new URL(SCRIPT_URL);
        urlDelete.searchParams.append("action", "deleteData");
        urlDelete.searchParams.append("data", JSON.stringify(original));

        const resDelete = await fetch(urlDelete.toString(), { method: "POST" });
        if (!resDelete.ok) throw new Error("B≈ÇƒÖd usuwania starego rekordu");

        // Nastƒôpnie dodaj nowy
        await addExpense(expense);

      } catch (error) {
        alert("B≈ÇƒÖd podczas aktualizacji wydatku: " + error.message);
      }
    }

    // Wyczy≈õƒá filtry
    document.getElementById("clearFilters").addEventListener("click", () => {
      ["filterDodajacy", "filterKtoPlaci", "filterPomieszczenie", "filterKategoria", "filterNazwa", "filterModel"].forEach(id => {
        document.getElementById(id).value = "";
      });
      applyFiltersAndRender();
    });

    // Obs≈Çuga filtr√≥w na ≈ºywo
    ["filterDodajacy", "filterKtoPlaci", "filterPomieszczenie", "filterKategoria", "filterNazwa", "filterModel"].forEach(id => {
      document.getElementById(id).addEventListener("input", applyFiltersAndRender);
    });

  // === GENEROWANIE PDF Z TABELƒÑ I WYKRESEM ===
  document.getElementById("exportPdfBtn").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'pt', 'a4');

    // Chwytamy tabelƒô i wykres jako canvas
    const table = document.getElementById("expensesTable");
    const chart = document.getElementById("categoryChart");

    // Najpierw tabela
    await html2canvas(table, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth() - 40;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 20, 20, pdfWidth, pdfHeight);
    });

    // Potem wykres (na drugiej stronie)
    pdf.addPage();
    await html2canvas(chart, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth() - 40;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      pdf.addImage(imgData, 'PNG', 20, 20, pdfWidth, pdfHeight);
    });

    pdf.save("wydatki_mieszkanie56.pdf");
  });

  // === START ===
  fetchData();

</script>

</body>
</html>
