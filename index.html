<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>ZarzƒÖdzanie Wydatkami Mieszkanie 56</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    .icon-btn { cursor: pointer; margin: 0 5px; }
  </style>
</head>
<body>
  <div style="text-align: center; margin-bottom: 20px;">
    <img src="https://jakon-inwest.pl/upload/pictures/budynekb.jpg" alt="Wizualizacja Sielskie Podolany" style="max-width: 100%; height: auto; border-radius: 8px;" />
  </div>
  
  <h1>ZarzƒÖdzanie Wydatkami Mieszkanie 56</h1>

  <form id="formularz">
    Data: <input type="date" id="data" required />
    Typ: <input type="text" id="typ" required />
    Model: <input type="text" id="model" required />
    Nazwa produktu: <input type="text" id="nazwa" required />
    Pomieszczenie: <input type="text" id="pomieszczenie" required />
    Kategoria: <input type="text" id="kategoria" required />
    Kwota (z≈Ç): <input type="number" id="kwota" min="0" step="0.01" required />
    Numer dokumentu: <input type="text" id="dokument" />
    DodajƒÖcy: <input type="text" id="dodajacy" required />
    Kto_placi: <input type="text" id="ponoszacy" required />
    <button type="submit">Dodaj wydatek</button>
  </form>

  <h2>Filtry</h2>
  Data (miesiƒÖc): <input type="month" id="filterData" />
  Pomieszczenie: <input type="text" id="filterPomieszczenie" placeholder="np. Kuchnia" />
  Nazwa produktu: <input type="text" id="filterNazwa" placeholder="np. Kran" />
  DodajƒÖcy: <input type="text" id="filterDodajacy" placeholder="Kto doda≈Ç" />
  PonoszƒÖcy koszt: <input type="text" id="filterPonoszacy" placeholder="Kto p≈Çaci" />

  <h2>Wydatki</h2>
  <table id="tabela">
    <thead>
      <tr>
        <th>Data</th><th>Typ</th><th>Model</th><th>Nazwa</th><th>Pomieszczenie</th><th>Kategoria</th><th>Kwota</th><th>Dokument</th><th>DodajƒÖcy</th><th>Kto_placi</th><th>Akcje</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Podsumowanie</h2>
  <div id="podsumowanie"></div>

  <h2>Wykres kategorii</h2>
  <canvas id="wykres" width="600" height="400"></canvas>

  <button id="exportExcel">Eksport do Excel</button>
  <button id="exportPDF">Eksport do PDF</button>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbxA3_ObGp8FH6MSh_abWIn0si_tB1CuGgbsEaNm_erLWx7BASE51qKZ2fBcBupIoFmIiA/exec?action=getData';

    let dane = [];
    let edytowanyId = null;

    document.getElementById('formularz').addEventListener('submit', dodajLubAktualizujWydatek);
    document.getElementById('filterData').addEventListener('input', pokazTabele);
    document.getElementById('filterPomieszczenie').addEventListener('input', pokazTabele);
    document.getElementById('filterNazwa').addEventListener('input', pokazTabele);
    document.getElementById('filterDodajacy').addEventListener('input', pokazTabele);
    document.getElementById('filterPonoszacy').addEventListener('input', pokazTabele);
    document.getElementById('exportExcel').addEventListener('click', eksportujDoExcel);
    document.getElementById('exportPDF').addEventListener('click', eksportujDoPDF);

    async function pobierzDane() {
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error("B≈ÇƒÖd pobierania danych");
        const data = await response.json();
        dane = data;
        pokazTabele();
        aktualizujPodsumowanie();
        rysujWykres();
      } catch (e) {
        alert(e.message);
      }
    }

    async function dodajLubAktualizujWydatek(event) {
      event.preventDefault();
      const data = document.getElementById('data').value;
      const typ = document.getElementById('typ').value.trim();
      const model = document.getElementById('model').value.trim();
      const nazwa = document.getElementById('nazwa').value.trim();
      const pomieszczenie = document.getElementById('pomieszczenie').value.trim();
      const kategoria = document.getElementById('kategoria').value.trim();
      const kwota = parseFloat(document.getElementById('kwota').value);
      const dokument = document.getElementById('dokument').value.trim();
      const dodajacy = document.getElementById('dodajacy').value.trim();
      const ponoszacy = document.getElementById('ponoszacy').value.trim();

      if (!data || !typ || !model || !nazwa || !pomieszczenie || !kategoria || isNaN(kwota) || kwota <= 0 || !dodajacy || !ponoszacy) {
        alert("Uzupe≈Çnij poprawnie wszystkie wymagane pola.");
        return;
      }

      const wydatek = { data, typ, model, nazwa, pomieszczenie, kategoria, kwota, dokument, dodajacy, ponoszacy };

      try {
        let response;
        if (edytowanyId === null) {
          response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(wydatek)
          });
        } else {
          wydatek.id = edytowanyId;
          response = await fetch(apiUrl + '?id=' + edytowanyId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(wydatek)
          });
        }
        if (!response.ok) throw new Error('B≈ÇƒÖd zapisu danych');
        edytowanyId = null;
        document.getElementById('formularz').reset();
        pobierzDane();
      } catch (e) {
        alert(e.message);
      }
    }

    function pokazTabele() {
      const tbody = document.querySelector("#tabela tbody");
      tbody.innerHTML = '';

      const filterData = document.getElementById('filterData').value;
      const filterPomieszczenie = document.getElementById('filterPomieszczenie').value.toLowerCase();
      const filterNazwa = document.getElementById('filterNazwa').value.toLowerCase();
      const filterDodajacy = document.getElementById('filterDodajacy').value.toLowerCase();
      const filterPonoszacy = document.getElementById('filterPonoszacy').value.toLowerCase();

      const filtrowane = dane.filter(wydatek => {
        if (filterData && !wydatek.data.startsWith(filterData)) return false;
        if (filterPomieszczenie && !wydatek.pomieszczenie.toLowerCase().includes(filterPomieszczenie)) return false;
        if (filterNazwa && !wydatek.nazwa.toLowerCase().includes(filterNazwa)) return false;
        if (filterDodajacy && !wydatek.dodajacy.toLowerCase().includes(filterDodajacy)) return false;
        if (filterPonoszacy && !wydatek.ponoszacy.toLowerCase().includes(filterPonoszacy)) return false;
        return true;
      });

      for (const w of filtrowane) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${w.data}</td>
          <td>${w.typ}</td>
          <td>${w.model}</td>
          <td>${w.nazwa}</td>
          <td>${w.pomieszczenie}</td>
          <td>${w.kategoria}</td>
          <td>${w.kwota.toFixed(2)}</td>
          <td>${w.dokument || ''}</td>
          <td>${w.dodajacy}</td>
          <td>${w.ponoszacy}</td>
          <td>
            <span class="icon-btn" title="Edytuj" onclick="edytujWydatek('${w.id}')">‚úèÔ∏è</span>
            <span class="icon-btn" title="Usu≈Ñ" onclick="usunWydatek('${w.id}')">üóëÔ∏è</span>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function edytujWydatek(id) {
      const wydatek = dane.find(d => d.id === id);
      if (!wydatek) return alert("Nie znaleziono wydatku");
      document.getElementById('data').value = wydatek.data;
      document.getElementById('typ').value = wydatek.typ;
      document.getElementById('model').value = wydatek.model;
      document.getElementById('nazwa').value = wydatek.nazwa;
      document.getElementById('pomieszczenie').value = wydatek.pomieszczenie;
      document.getElementById('kategoria').value = wydatek.kategoria;
      document.getElementById('kwota').value = wydatek.kwota;
      document.getElementById('dokument').value = wydatek.dokument;
      document.getElementById('dodajacy').value = wydatek.dodajacy;
      document.getElementById('ponoszacy').value = wydatek.ponoszacy;
      edytowanyId = id;
    }

    async function usunWydatek(id) {
      if (!confirm('Czy na pewno chcesz usunƒÖƒá ten wydatek?')) return;
      try {
        const response = await fetch(apiUrl + '?id=' + id, { method: 'DELETE' });
        if (!response.ok) throw new Error("B≈ÇƒÖd usuwania");
        pobierzDane();
      } catch (e) {
        alert(e.message);
      }
    }

    function aktualizujPodsumowanie() {
      const podsumDiv = document.getElementById('podsumowanie');
      podsumDiv.innerHTML = '';

      const suma = dane.reduce((acc, cur) => acc + cur.kwota, 0);
      const kategorie = {};
      const dodajacy = {};

      for (const w of dane) {
        kategorie[w.kategoria] = (kategorie[w.kategoria] || 0) + w.kwota;
        dodajacy[w.dodajacy] = (dodajacy[w.dodajacy] || 0) + w.kwota;
      }

      function procent(kwota) {
        return suma > 0 ? ((kwota / suma) * 100).toFixed(1) : "0.0";
      }

      let html = `<strong>≈ÅƒÖcznie: </strong>${suma.toFixed(2)} z≈Ç<br><br>`;
      html += '<strong>Udzia≈Ç wg kategorii:</strong><ul>';
      for (const k in kategorie) {
        html += `<li>${k}: ${kategorie[k].toFixed(2)} z≈Ç (${procent(kategorie[k])}%)</li>`;
      }
      html += '</ul>';

      html += '<strong>Udzia≈Ç wg os√≥b dodajƒÖcych:</strong><ul>';
      for (const d in dodajacy) {
        html += `<li>${d}: ${dodajacy[d].toFixed(2)} z≈Ç (${procent(dodajacy[d])}%)</li>`;
      }
      html += '</ul>';

      podsumDiv.innerHTML = html;
    }

    function rysujWykres() {
      const ctx = document.getElementById('wykres').getContext('2d');
      const kategorie = {};
      for (const w of dane) {
        kategorie[w.kategoria] = (kategorie[w.kategoria] || 0) + w.kwota;
      }

      const labels = Object.keys(kategorie);
      const values = Object.values(kategorie);
      const colors = labels.map(() => `hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`);

      if (window.wykresInstance) window.wykresInstance.destroy();

      window.wykresInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function eksportujDoExcel() {
      const ws = XLSX.utils.json_to_sheet(dane);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Wydatki');
      XLSX.writeFile(wb, 'wydatki_mieszkanie56.xlsx');
    }

    function eksportujDoPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(14);
      doc.text("Wydatki Mieszkanie 56", 10, 10);

      const headers = [["Data", "Typ", "Model", "Nazwa", "Pomieszczenie", "Kategoria", "Kwota", "Dokument", "DodajƒÖcy", "Kto-placi"]];
      const rows = dane.map(w => [
        w.data, w.typ, w.model, w.nazwa, w.pomieszczenie,
        w.kategoria, w.kwota.toFixed(2), w.dokument || '', w.dodajacy, w.ponoszacy
      ]);

      if (rows.length > 0) {
        doc.autoTable({
          head: headers,
          body: rows,
          startY: 20,
          styles: { fontSize: 8 },
          headStyles: { fillColor: [220, 220, 220] }
        });
      } else {
        doc.text("Brak danych do wy≈õwietlenia.", 10, 20);
      }

      doc.save('wydatki_mieszkanie56.pdf');
    }

    pobierzDane();
  </script>
</body>
</html>
