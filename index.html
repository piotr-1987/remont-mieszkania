<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<title>Zarządzanie wydatkami remontu</title>
<style>
  table { border-collapse: collapse; width: 100%; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background-color: #eee; }
  input, select { width: 100%; }
  button { margin-top: 10px; }
</style>
</head>
<body>

<h2>Lista wydatków remontu</h2>
<table id="expensesTable">
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Dodaj / Edytuj wydatek</h3>
<form id="expenseForm">
  <input type="hidden" id="ID" />
  <label>Nr dokumentu:<br/><input type="text" id="Nr dokumentu" required /></label><br/>
  <label>Kategoria:<br/><input type="text" id="Kategoria" required /></label><br/>
  <label>Pomieszczenie:<br/><input type="text" id="Pomieszczenie" /></label><br/>
  <label>Data:<br/><input type="date" id="Data" required /></label><br/>
  <label>Nazwa produktu:<br/><input type="text" id="Nazwa produktu" /></label><br/>
  <label>Model produktu:<br/><input type="text" id="Model produktu" /></label><br/>
  <label>Kwota:<br/><input type="number" step="0.01" id="Kwota" required /></label><br/>
  <button type="submit">Zapisz</button>
  <button type="button" id="cancelEdit">Anuluj edycję</button>
</form>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/TWOJ_DEPLOY_ID/exec';

  let expenses = [];
  let editingID = null;

  // Funkcja pomocnicza do wywołań backendu przez google.script.run (w tym wypadku musisz użyć Google Apps Script Web App lub REST API)
  // Tutaj przykład fetch - zakładam, że twój backend ma odpowiednie endpointy REST (musiałbyś je stworzyć)
  
  // W praktyce Google Apps Script wymaga użycia google.script.run z HTML Service lub fetch do endpointów REST (publish as web app)
  
  async function fetchExpenses() {
    // Przykład jak to może wyglądać jeśli masz endpoint REST GET /getExpenses
    const response = await fetch(SCRIPT_URL + '?action=getExpenses');
    const data = await response.json();
    return data;
  }

  // Pobierz dane i wyświetl w tabeli
  async function loadExpenses() {
    try {
      // Pobierz dane z backendu
      const response = await fetch(SCRIPT_URL + '?action=getExpenses');
      expenses = await response.json();
      renderTable(expenses);
    } catch(e) {
      alert('Błąd pobierania danych: ' + e.message);
    }
  }

  // Renderuj nagłówki i wiersze tabeli
  function renderTable(data) {
    const tableHeader = document.getElementById('tableHeader');
    const tbody = document.querySelector('#expensesTable tbody');
    tbody.innerHTML = '';

    if (data.length === 0) {
      tableHeader.innerHTML = '';
      return;
    }

    // Wyświetl nagłówki
    const headers = Object.keys(data[0]);
    tableHeader.innerHTML = '';
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      tableHeader.appendChild(th);
    });
    // Dodaj kolumnę Akcje
    const th = document.createElement('th');
    th.textContent = 'Akcje';
    tableHeader.appendChild(th);

    // Wiersze
    data.forEach(item => {
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const td = document.createElement('td');
        td.textContent = item[h];
        tr.appendChild(td);
      });

      // Akcje: Edytuj, Usuń
      const actionTd = document.createElement('td');
      const editBtn = document.createElement('button');
      editBtn.textContent = 'Edytuj';
      editBtn.onclick = () => startEdit(item);
      actionTd.appendChild(editBtn);

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Usuń';
      delBtn.onclick = () => deleteExpense(item.ID);
      actionTd.appendChild(delBtn);

      tr.appendChild(actionTd);
      tbody.appendChild(tr);
    });
  }

  // Wypełnij formularz danymi do edycji
  function startEdit(item) {
    editingID = item.ID;
    for (const key in item) {
      const el = document.getElementById(key);
      if (el) el.value = item[key];
    }
  }

  // Anuluj edycję
  document.getElementById('cancelEdit').onclick = () => {
    editingID = null;
    document.getElementById('expenseForm').reset();
  };

  // Obsługa zapisu formularza
  document.getElementById('expenseForm').onsubmit = async (e) => {
    e.preventDefault();

    const expense = {};
    const fields = ['ID', 'Nr dokumentu', 'Kategoria', 'Pomieszczenie', 'Data', 'Nazwa produktu', 'Model produktu', 'Kwota'];
    fields.forEach(f => {
      const el = document.getElementById(f);
      expense[f] = el ? el.value : '';
    });

    try {
      let url;
      let method;
      if (editingID) {
        // Edycja
        url = SCRIPT_URL + '?action=updateExpense';
        method = 'POST';
      } else {
        // Dodanie nowego - generujemy unikalne ID
        expense.ID = Date.now().toString();
        url = SCRIPT_URL + '?action=addExpense';
        method = 'POST';
      }

      const response = await fetch(url, {
        method: method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(expense)
      });
      const result = await response.json();

      if (result.status === 'success') {
        alert('Zapisano');
        editingID = null;
        document.getElementById('expenseForm').reset();
        loadExpenses();
      } else {
        alert('Błąd: ' + result.message);
      }
    } catch(err) {
      alert('Błąd zapisu: ' + err.message);
    }
  };

  // Usuń wydatek
  async function deleteExpense(id) {
    if (!confirm('Na pewno chcesz usunąć ten wydatek?')) return;
    try {
      const response = await fetch(SCRIPT_URL + '?action=deleteExpense', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ ID: id })
      });
      const result = await response.json();
      if (result.status === 'success') {
        alert('Usunięto');
        loadExpenses();
      } else {
        alert('Błąd: ' + result.message);
      }
    } catch(e) {
      alert('Błąd usuwania: ' + e.message);
    }
  }

  // Załaduj dane przy starcie
  loadExpenses();
</script>

</body>
</html>
