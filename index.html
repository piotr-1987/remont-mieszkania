<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Wydatki Mieszkanie 56 - Sielskie Podolany</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f7f7f7; }
    h1 { color: #333; }
    .filters, .form-container { margin-bottom: 20px; padding: 10px; background: #fff; border-radius: 8px; }
    table { border-collapse: collapse; width: 100%; background: #fff; margin-bottom: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    button { padding: 6px 12px; margin: 2px; cursor: pointer; }
    .charts { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 20px; }
    .chart-box { flex: 1 1 45%; background: #fff; padding: 10px; border-radius: 8px; }
    .summary { font-weight: bold; font-size: 1.1em; margin-top: 10px; }
  </style>
</head>
<body>

  <h1>üí∞ Wydatki - Mieszkanie 56</h1>
  <img src="naglowek.jpg" alt="Nag≈Ç√≥wek" style="max-width:100%; border-radius:10px; margin-bottom:20px;">

  <div class="form-container">
    <h3>Dodaj / Edytuj wydatek</h3>
    <form id="expenseForm">
      <input type="hidden" id="rowNum">
      Data: <input type="date" id="data" required>
      Typ: <input type="text" id="typ" required>
      Nazwa: <input type="text" id="nazwa">
      Model: <input type="text" id="model">
      Pomieszczenie: <input type="text" id="pomieszczenie">
      Kategoria: <input type="text" id="kategoria">
      Kwota: <input type="number" id="kwota" step="0.01" required>
      Dokument: <input type="text" id="dokument">
      DodajƒÖcy: <input type="text" id="dodajacy">
      Kto p≈Çaci: <input type="text" id="kto_placi">
      <button type="submit">üíæ Zapisz</button>
    </form>
  </div>

  <div class="filters">
    <h3>Filtry</h3>
    Kategoria: <input type="text" id="filterKategoria">
    Pomieszczenie: <input type="text" id="filterPomieszczenie">
    Nazwa: <input type="text" id="filterNazwa">
    Model: <input type="text" id="filterModel">
    <button onclick="applyFilters()">üîç Filtruj</button>
    <button onclick="resetFilters()">‚ôªÔ∏è Reset</button>
  </div>

  <table id="expensesTable">
    <thead>
      <tr>
        <th>Data</th><th>Typ</th><th>Nazwa</th><th>Model</th>
        <th>Pomieszczenie</th><th>Kategoria</th><th>Kwota</th>
        <th>Dokument</th><th>DodajƒÖcy</th><th>Kto p≈Çaci</th><th>Akcje</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="summary" id="summaryText">Do tej pory wydano: 0 z≈Ç</div>
  <button onclick="downloadPDF()">üìÑ Pobierz PDF</button>

  <div class="charts">
    <div class="chart-box"><canvas id="categoryChart"></canvas></div>
    <div class="chart-box"><canvas id="timeChart"></canvas></div>
  </div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwXoypXjdAHQtXPW6w53FCrqdrJ3LeYpo--zjd97g94zVNBqZsx_ZFe6QlBZe2ydN7jhQ/exec";
let expensesData = [];

// Pobranie danych z Google Sheets
async function fetchExpenses() {
  try {
    const res = await fetch(SCRIPT_URL);
    expensesData = await res.json();
    renderTable(expensesData);
    updateCharts(expensesData);
    updateSummary(expensesData);
  } catch(e) {
    console.error("B≈ÇƒÖd fetch:", e);
  }
}

// Render tabeli
function renderTable(data) {
  const tbody = document.querySelector("#expensesTable tbody");
  tbody.innerHTML = "";
  data.forEach((exp, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${exp.data}</td>
      <td>${exp.typ}</td>
      <td>${exp.nazwa}</td>
      <td>${exp.model}</td>
      <td>${exp.pomieszczenie}</td>
      <td>${exp.kategoria}</td>
      <td>${exp.kwota}</td>
      <td>${exp.dokument}</td>
      <td>${exp.dodajacy}</td>
      <td>${exp.kto_placi}</td>
      <td>
        <button onclick="editExpense(${i})">‚úèÔ∏è</button>
        <button onclick="deleteExpense(${i})">üóëÔ∏è</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

// Dodawanie / aktualizacja
document.getElementById("expenseForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData();
  const rowNum = document.getElementById("rowNum").value;

  formData.append("action", rowNum ? "updateData" : "addData");
  formData.append("rowNum", rowNum);
  formData.append("data", document.getElementById("data").value);
  formData.append("typ", document.getElementById("typ").value);
  formData.append("nazwa", document.getElementById("nazwa").value);
  formData.append("model", document.getElementById("model").value);
  formData.append("pomieszczenie", document.getElementById("pomieszczenie").value);
  formData.append("kategoria", document.getElementById("kategoria").value);
  formData.append("kwota", document.getElementById("kwota").value);
  formData.append("dokument", document.getElementById("dokument").value);
  formData.append("dodajacy", document.getElementById("dodajacy").value);
  formData.append("kto_placi", document.getElementById("kto_placi").value);

  await fetch(SCRIPT_URL, { method: "POST", body: formData });

  document.getElementById("expenseForm").reset();
  document.getElementById("rowNum").value = "";
  fetchExpenses();
});

// Edycja
function editExpense(index) {
  const exp = expensesData[index];
  document.getElementById("rowNum").value = exp._rowNum;
  document.getElementById("data").value = exp.data;
  document.getElementById("typ").value = exp.typ;
  document.getElementById("nazwa").value = exp.nazwa;
  document.getElementById("model").value = exp.model;
  document.getElementById("pomieszczenie").value = exp.pomieszczenie;
  document.getElementById("kategoria").value = exp.kategoria;
  document.getElementById("kwota").value = exp.kwota;
  document.getElementById("dokument").value = exp.dokument;
  document.getElementById("dodajacy").value = exp.dodajacy;
  document.getElementById("kto_placi").value = exp.kto_placi;
}

// Usuwanie
async function deleteExpense(index) {
  const exp = expensesData[index];
  if(!confirm("Na pewno usunƒÖƒá ten wydatek?")) return;

  const formData = new FormData();
  formData.append("action", "deleteData");
  formData.append("data", exp.data);
  formData.append("typ", exp.typ);
  formData.append("kwota", exp.kwota);

  await fetch(SCRIPT_URL, { method: "POST", body: formData });
  fetchExpenses();
}

// Filtry
function applyFilters() {
  const k = document.getElementById("filterKategoria").value.toLowerCase();
  const p = document.getElementById("filterPomieszczenie").value.toLowerCase();
  const n = document.getElementById("filterNazwa").value.toLowerCase();
  const m = document.getElementById("filterModel").value.toLowerCase();

  const filtered = expensesData.filter(e =>
    (!k || e.kategoria.toLowerCase().includes(k)) &&
    (!p || e.pomieszczenie.toLowerCase().includes(p)) &&
    (!n || e.nazwa.toLowerCase().includes(n)) &&
    (!m || e.model.toLowerCase().includes(m))
  );

  renderTable(filtered);
  updateCharts(filtered);
  updateSummary(filtered);
}

function resetFilters() {
  document.getElementById("filterKategoria").value = "";
  document.getElementById("filterPomieszczenie").value = "";
  document.getElementById("filterNazwa").value = "";
  document.getElementById("filterModel").value = "";
  renderTable(expensesData);
  updateCharts(expensesData);
  updateSummary(expensesData);
}

// Podsumowanie
function updateSummary(data) {
  const sum = data.reduce((a,b)=>a+parseFloat(b.kwota||0),0);
  document.getElementById("summaryText").innerText = `Do tej pory wydano: ${sum.toFixed(2)} z≈Ç`;
}

// Wykresy
let categoryChart, timeChart;
function updateCharts(data) {
  const byCategory = {};
  const byMonth = {};
  data.forEach(e=>{
    byCategory[e.kategoria] = (byCategory[e.kategoria]||0)+parseFloat(e.kwota||0);
    const month = e.data ? e.data.slice(0,7) : "brak";
    byMonth[month] = (byMonth[month]||0)+parseFloat(e.kwota||0);
  });

  if(categoryChart) categoryChart.destroy();
  if(timeChart) timeChart.destroy();

  categoryChart = new Chart(document.getElementById("categoryChart"), {
    type:"pie",
    data:{ labels: Object.keys(byCategory), datasets:[{ data: Object.values(byCategory) }] }
  });

  timeChart = new Chart(document.getElementById("timeChart"), {
    type:"line",
    data:{ labels: Object.keys(byMonth), datasets:[{ label:"Wydatki w czasie", data:Object.values(byMonth) }] }
  });
}

// PDF
function downloadPDF() {
  const element = document.body;
  const opt = { margin:0.5, filename:"wydatki.pdf", image:{type:"jpeg", quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:"in", format:"a4", orientation:"portrait"} };
  html2pdf().set(opt).from(element).save();
}

window.onload = fetchExpenses;
</script>

</body>
</html>
