<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remont mieszkania nr 56 - Sielskie Podolany</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    input, select, button { margin: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #eee; }
    .filters, .summary, .chart-container { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Remont mieszkania nr 56 - Sielskie Podolany</h1>

  <div>
    <input type="date" id="data">
    <input type="text" id="produkt" placeholder="Nazwa produktu">
    <input type="text" id="model" placeholder="Model">
    <input type="number" id="kwota" placeholder="Kwota">
    <input type="text" id="dokument" placeholder="Nr dokumentu">
    <select id="pomieszczenie">
      <option value="Łazienka">Łazienka</option>
      <option value="Aneks kuchenny">Aneks kuchenny</option>
      <option value="Sypialnia">Sypialnia</option>
      <option value="Ogród">Ogród</option>
    </select>
    <select id="kategoria">
      <option value="Wyposażenie">Wyposażenie</option>
      <option value="Sprzęt">Sprzęt</option>
      <option value="Materiał budowlany">Materiał budowlany</option>
      <option value="Robocizna">Robocizna</option>
    </select>
    <select id="ktoDodal">
      <option value="Marta">Marta</option>
      <option value="Piotr">Piotr</option>
    </select>
    <select id="ktoPoniosl">
      <option value="Marta">Marta</option>
      <option value="Piotr">Piotr</option>
    </select>
    <button onclick="dodajWydatek()">Dodaj wydatek</button>
  </div>

  <div class="filters">
    <input type="text" id="filtrProdukt" placeholder="Filtr: Produkt">
    <select id="filtrPomieszczenie">
      <option value="">Wszystkie pomieszczenia</option>
      <option value="Łazienka">Łazienka</option>
      <option value="Aneks kuchenny">Aneks kuchenny</option>
      <option value="Sypialnia">Sypialnia</option>
      <option value="Ogród">Ogród</option>
    </select>
    <input type="month" id="filtrData">
    <button onclick="filtrujWydatki()">Filtruj</button>
  </div>

  <div class="summary" id="podsumowanie"></div>
  <div class="chart-container">
    <canvas id="wykres" width="800" height="400"></canvas>
  </div>

  <table id="tabela"></table>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let wydatki = JSON.parse(localStorage.getItem('wydatki')) || [];

    function dodajWydatek() {
      const data = document.getElementById('data').value;
      const produkt = document.getElementById('produkt').value;
      const model = document.getElementById('model').value;
      const kwota = parseFloat(document.getElementById('kwota').value);
      const dokument = document.getElementById('dokument').value;
      const pomieszczenie = document.getElementById('pomieszczenie').value;
      const kategoria = document.getElementById('kategoria').value;
      const ktoDodal = document.getElementById('ktoDodal').value;
      const ktoPoniosl = document.getElementById('ktoPoniosl').value;

      if (!data || !produkt || isNaN(kwota)) return alert('Uzupełnij wymagane pola.');

      wydatki.push({ data, produkt, model, kwota, dokument, pomieszczenie, kategoria, ktoDodal, ktoPoniosl });
      localStorage.setItem('wydatki', JSON.stringify(wydatki));

      pokazTabele();
      pokazPodsumowanie();
      rysujWykres();
    }

    function filtrujDane() {
      const filtrProdukt = document.getElementById('filtrProdukt').value.toLowerCase();
      const filtrPom = document.getElementById('filtrPomieszczenie').value;
      const filtrData = document.getElementById('filtrData').value;

      return wydatki.filter(w =>
        (!filtrProdukt || w.produkt.toLowerCase().includes(filtrProdukt)) &&
        (!filtrPom || w.pomieszczenie === filtrPom) &&
        (!filtrData || w.data.startsWith(filtrData))
      );
    }

    function filtrujWydatki() {
      pokazTabele();
      pokazPodsumowanie();
      rysujWykres();
    }

    function pokazTabele() {
      const tabela = document.getElementById('tabela');
      const dane = filtrujDane();
      tabela.innerHTML = `
        <tr><th>Data</th><th>Produkt</th><th>Model</th><th>Kwota</th><th>Dokument</th><th>Pomieszczenie</th><th>Kategoria</th><th>Kto dodał</th><th>Kto poniósł</th><th>Usuń</th></tr>
        ${dane.map((w, i) => `<tr>
          <td>${w.data}</td><td>${w.produkt}</td><td>${w.model}</td><td>${w.kwota.toFixed(2)}</td>
          <td>${w.dokument}</td><td>${w.pomieszczenie}</td><td>${w.kategoria}</td><td>${w.ktoDodal}</td><td>${w.ktoPoniosl}</td>
          <td><button onclick="usunWydatek(${i})">Usuń</button></td>
        </tr>`).join('')}
      `;
    }

    function usunWydatek(index) {
      const filtrowane = filtrujDane();
      const oryginalnyIndex = wydatki.findIndex(w => w.data === filtrowane[index].data && w.produkt === filtrowane[index].produkt);
      if (oryginalnyIndex !== -1) wydatki.splice(oryginalnyIndex, 1);
      localStorage.setItem('wydatki', JSON.stringify(wydatki));
      pokazTabele();
      pokazPodsumowanie();
      rysujWykres();
    }

    function pokazPodsumowanie() {
      const filtrowane = filtrujDane();
      let sumaMarta = 0;
      let sumaPiotr = 0;
      const sumaPomieszczenia = {};
      const sumaKategorii = {};

      filtrowane.forEach(w => {
        if (w.ktoPoniosl === 'Marta') sumaMarta += w.kwota;
        else if (w.ktoPoniosl === 'Piotr') sumaPiotr += w.kwota;

        if (!sumaPomieszczenia[w.pomieszczenie]) sumaPomieszczenia[w.pomieszczenie] = 0;
        sumaPomieszczenia[w.pomieszczenie] += w.kwota;

        if (!sumaKategorii[w.kategoria]) sumaKategorii[w.kategoria] = 0;
        sumaKategorii[w.kategoria] += w.kwota;
      });

      document.getElementById('podsumowanie').innerHTML = `
        <h3>Podsumowanie kosztów wg osoby ponoszącej wydatek:</h3>
        <p><strong>Marta:</strong> ${sumaMarta.toFixed(2)} zł</p>
        <p><strong>Piotr:</strong> ${sumaPiotr.toFixed(2)} zł</p>
        <p><strong>Razem:</strong> ${(sumaMarta + sumaPiotr).toFixed(2)} zł</p>
        <h3>Podsumowanie kosztów wg pomieszczeń:</h3>
        <ul>${Object.entries(sumaPomieszczenia).map(([k,v]) => `<li><strong>${k}:</strong> ${v.toFixed(2)} zł</li>`).join('')}</ul>
        <h3>Podsumowanie kosztów wg kategorii:</h3>
        <ul>${Object.entries(sumaKategorii).map(([k,v]) => `<li><strong>${k}:</strong> ${v.toFixed(2)} zł</li>`).join('')}</ul>
      `;
    }

    function rysujWykres() {
      const dane = filtrujDane();
      const miesiace = {};
      dane.forEach(w => {
        const miesiac = w.data.slice(0, 7);
        if (!miesiace[miesiac]) miesiace[miesiac] = 0;
        miesiace[miesiac] += w.kwota;
      });

      const ctx = document.getElementById('wykres').getContext('2d');
      if (window.wykres) window.wykres.destroy();
      window.wykres = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(miesiace),
          datasets: [{
            label: 'Wydatki w czasie',
            data: Object.values(miesiace),
            backgroundColor: 'rgba(75, 192, 192, 0.6)'
          }]
        }
      });
    }

    pokazTabele();
    pokazPodsumowanie();
    rysujWykres();
  </script>
</body>
</html>
